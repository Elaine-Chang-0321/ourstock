<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>庫存股市值</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    nav {
      background-color: #333;
      padding: 10px 0;
    }
    nav a {
      color: white;
      text-decoration: none;
      margin: 0 15px;
      font-weight: bold;
    }
    nav a:hover {
      color: #ffcc00;
    }
    main {
      margin: 40px auto;
      width: 80%;
      max-width: 800px;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    form {
      margin-bottom: 30px;
    }
    form input, form button {
      margin: 5px;
      padding: 8px;
      font-size: 1em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
    }
    th {
      background-color: #333;
      color: white;
    }
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    .delete-btn {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 4px;
    }
    .delete-btn:hover {
      background-color: #c0392b;
    }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">庫存股市值</a>
    <a href="portfolio.html">已實現損益</a>
  </nav>
  <main>
    <h1>庫存股市值</h1>
    <form>
      <input type="text" placeholder="股票代號" required>
      <input type="text" placeholder="股票名稱" required>
      <input type="date" required>
      <input type="number" placeholder="股數" required>
      <input type="number" step="0.01" placeholder="價格" required>
      <input type="number" step="0.01" placeholder="應收付">
      <button type="submit">新增</button>
    </form>
    <table>
      <thead>
        <tr>
          <th>股票代號</th>
          <th>股票名稱</th>
          <th>購買日期</th>
          <th>股數</th>
          <th>價格</th>
          <th>應收付</th>
          <th>即時股價</th>
          <th>損益</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <!-- 股票資料列 -->
      </tbody>
    </table>
  </main>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.querySelector('form');
      const tbody = document.querySelector('tbody');
      const STORAGE_KEY = 'indexStocks';

      const loadData = () => {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        tbody.innerHTML = '';
        data.forEach((stock, index) => addRow(stock, index));
      };

      const addRow = (stock, index) => {
        const tr = document.createElement('tr');
        const profit = stock.currentPrice
          ? ((stock.currentPrice - stock.price) * stock.quantity).toFixed(2)
          : '-';
        tr.innerHTML = `
          <td>${stock.code}</td>
          <td>${stock.name}</td>
          <td>${stock.date}</td>
          <td>${stock.quantity}</td>
          <td>${stock.price}</td>
          <td>${stock.receivable ?? 0}</td>
          <td>${stock.currentPrice ?? '-'}</td>
          <td>${profit}</td>
        `;
        const deleteButton = document.createElement('button');
        deleteButton.textContent = '刪除';
        deleteButton.classList.add('delete-btn');
        deleteButton.addEventListener('click', () => {
          const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
          data.splice(index, 1);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          loadData();
        });
        const td = document.createElement('td');
        td.appendChild(deleteButton);
        tr.appendChild(td);
        tbody.appendChild(tr);
      };

      async function updatePrices() {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        const symbols = data.map(stock => stock.code);
        if (symbols.length === 0) return alert('沒有可更新的股票資料');
        try {
          const apiBase = window.location.origin;
          const response = await fetch(`${apiBase}/price`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ symbols })
          });
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const prices = await response.json();
          console.log('取得股價資料:', prices);
          data.forEach(stock => {
            // 嘗試比對完整代號與去除市場代碼的代號
            const cleanCode = stock.code.split('.')[0];
            if (prices[stock.code]) {
              stock.currentPrice = prices[stock.code];
            } else if (prices[cleanCode]) {
              stock.currentPrice = prices[cleanCode];
            } else {
              stock.currentPrice = '-';
            }
          });
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          loadData();
          alert('股價更新完成');
        } catch (error) {
          console.error('更新股價失敗:', error);
          alert('更新股價時發生錯誤，請檢查伺服器是否運作中');
        }
      }

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const inputs = form.querySelectorAll('input');
        const stock = {
          code: inputs[0].value.trim(),
          name: inputs[1].value.trim(),
          date: inputs[2].value,
          quantity: parseInt(inputs[3].value),
          price: parseFloat(inputs[4].value),
          receivable: parseFloat(inputs[5].value) || 0
        };
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        data.push(stock);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        loadData();
        form.reset();
      });

      const updateButton = document.createElement('button');
      updateButton.textContent = '更新股價';
      updateButton.style.marginTop = '15px';
      updateButton.addEventListener('click', updatePrices);
      document.querySelector('main').appendChild(updateButton);

      loadData();
    });
  </script>
</body>
</html>