<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>投資組合</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    nav {
      background-color: #333;
      padding: 10px 0;
    }
    nav a {
      color: white;
      text-decoration: none;
      margin: 0 15px;
      font-weight: bold;
    }
    nav a:hover {
      color: #ffcc00;
    }
    main {
      margin: 40px auto;
      width: 80%;
      max-width: 800px;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    form {
      margin-bottom: 30px;
    }
    form input, form button {
      margin: 5px;
      padding: 8px;
      font-size: 1em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
    }
    th {
      background-color: #333;
      color: white;
    }
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    .delete-btn {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 4px;
    }
    .delete-btn:hover {
      background-color: #c0392b;
    }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">庫存股市值</a>
    <a href="portfolio.html">已實現損益</a>
  </nav>
  <main>
    <h1>投資組合管理</h1>
    <form>
      <input type="text" placeholder="股票代號" required>
      <input type="text" placeholder="股票名稱" required>
      <input type="date" required>
      <input type="number" placeholder="股數" required>
      <input type="number" step="0.01" placeholder="價格" required>
      <input type="number" step="0.01" placeholder="應收付">
      <button type="submit">新增</button>
    </form>
    <table>
      <thead>
        <tr>
          <th>股票代號</th>
          <th>股票名稱</th>
          <th>購買日期</th>
          <th>股數</th>
          <th>價格</th>
          <th>應收付</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <!-- 股票資料列 -->
      </tbody>
    </table>
  </main>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.querySelector('form');
      const tbody = document.querySelector('tbody');
      const STORAGE_KEY = 'portfolioData';

      // 初始化：從 localStorage 載入資料
      const loadData = () => {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        tbody.innerHTML = '';
        data.forEach((stock, index) => addRow(stock, index));
      };

      // 新增表格列
      const addRow = (stock, index) => {
       const tr = document.createElement('tr');
       tr.innerHTML = `
         <td>${stock.code}</td>
         <td>${stock.name}</td>
         <td>${stock.date}</td>
         <td>${stock.shares}</td>
         <td>${stock.price}</td>
       <td>${stock.receivable ?? 0}</td>
       `;
      const deleteButton = document.createElement('button');
       deleteButton.textContent = '刪除';
       deleteButton.classList.add('delete-btn');
       deleteButton.addEventListener('click', () => {
         const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
         data.splice(index, 1);
         localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
         loadData();
         // updateInventory(); // 已停用，避免影響 index.html
       });
       const td = document.createElement('td');
       td.appendChild(deleteButton);
       tr.appendChild(td);
       tbody.appendChild(tr);
     };

      // 更新庫存資料
      const updateInventory = () => {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        const inventory = {};
        data.forEach(stock => {
          if (!inventory[stock.code]) {
            inventory[stock.code] = { name: stock.name, quantity: 0, price: stock.price };
          }
          inventory[stock.code].quantity += parseInt(stock.shares);
        });
        for (const code in inventory) {
          if (inventory[code].quantity <= 0) delete inventory[code];
        }
        console.log("updateInventory() called, current inventory:", inventory);
        localStorage.setItem('inventory', JSON.stringify(inventory));
      };

      // 表單提交事件
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const inputs = form.querySelectorAll('input');
        const stock = {
          code: inputs[0].value.trim(),
          name: inputs[1].value.trim(),
          date: inputs[2].value,
          shares: parseInt(inputs[3].value),
          price: parseFloat(inputs[4].value),
          receivable: parseFloat(inputs[5].value) || 0
        };

        // 新增至表格
        addRow(stock);

        // 儲存至 localStorage
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        data.push(stock);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

        // 更新庫存
        // updateInventory(); // 已停用，避免影響 index.html

        // 清空表單
        form.reset();
      });

      // 初始化載入
      loadData();
      // updateInventory(); // 已停用，避免影響 index.html
    });
  </script>
</body>
</html>